name: Pull-Request Checks

on:
  pull_request:

permissions:
  id-token: write
  contents: read

jobs:
  ci:
      name: 'Run tests, lint and validate'
      runs-on: 'ubuntu-latest'
      steps:
        - name: 'Checkout code'
          uses: 'actions/checkout@v3'

        - name: 'Setup nodeJS'
          if: ${{ success() }}
          uses: actions/setup-node@v4
          with:
            node-version: '20.9.0'

        - name: 'Install dependencies'
          if: ${{ success() }}
          run: npm install

        - name: 'Build source code'
          if: ${{ success() }}
          run: npm run build

        - name: 'Run the linter'
          if: ${{ success() }}
          run: npm run lint

        - name: 'Run unit tests'
          if: ${{ success() }}
          run: npm run test

        - name: Setup SAM CLI
          uses: aws-actions/setup-sam@v2
          with:
            version: 1.90.0
            use-installer: true

        - name: SAM Validate
          run: |
            echo "SAM_CLI_TELEMETRY=0" >> $GITHUB_ENV
            cd deploy && sam validate
          with: 
            aws-region: eu-west-2
